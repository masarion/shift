<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シフト希望入力</title>
    <style>
        /* === 1. 基本設定とスマホ最適化 === */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
        }

        #container {
            width: 100%;
            max-width: 600px;
            background-color: #ffffff;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }

        #dynamic-month-title {
            text-align: center;
            color: #1a73e8;
            font-size: 1.6em;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        /* === 2. 管理者用の説明書き/注意事項のスタイル === */
        .admin-note-box {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        /* 1つ目の注意事項（締め切りなど）: 黄色 */
        .admin-caution-first {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            font-weight: bold;
        }

        /* 2つ目の注意事項（送信ボタンの上）: 青色 */
        .admin-caution-second {
            background-color: #e2f0fd;
            color: #0c5460;
            border: 1px solid #b8daff;
        }

        /* 備考欄の説明書き: 薄いグレー */
        .admin-remark-info {
            background-color: #f0f0f0;
            color: #555;
            border: 1px solid #ddd;
        }

        /* === 3. カレンダー関連のスタイル（変更なし） === */
        #calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .weekday {
            text-align: center;
            font-weight: bold;
            padding: 5px 0;
            font-size: 0.85em;
            color: #555;
        }
        .day-cell {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 6px;
            cursor: pointer;
            min-height: 50px;
            padding: 5px;
            text-align: right;
            position: relative;
            transition: background-color 0.1s;
        }
        .day-cell.locked {
            background-color: #eceff1;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .day-cell:not(.locked):hover {
            background-color: #f0f0f0;
        }

        .date-number {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            display: block;
            margin-bottom: 3px;
        }
        .shift-display {
            font-size: 0.7em;
            font-weight: 600;
            line-height: 1.2;
            text-align: center;
            padding: 2px 0;
            border-radius: 3px;
        }

        /* === 4. シフトのカラーコード（変更なし） === */
        /* CSSクラス名は設定エリアで定義されたものをそのまま使用 */
        .shift-hayade { background-color: #4CAF50; color: white; }
        .shift-hayade-630 { background-color: #8BC34A; color: white; }
        .shift-osode { background-color: #2196F3; color: white; }
        .shift-osode-2230 { background-color: #03A9F4; color: white; }
        .shift-yasumi { background-color: #F44336; color: white; }

        /* === 5. モーダルと送信ボタン（変更なし） === */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .shift-option-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        .shift-option-grid button {
            padding: 15px 10px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.1s;
        }
        .shift-option-grid button:hover {
            opacity: 0.8;
        }
        #submission-area {
            padding: 15px;
            border-top: 1px solid #eee;
            margin-top: 15px;
        }
        #submission-area input, #submission-area textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
        }
        #submit-button {
            width: 100%;
            padding: 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        #submit-button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        #submit-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #loading-message {
            text-align: center;
            color: #007bff;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="container">
        
        <h2 id="dynamic-month-title"></h2>

        <div class="admin-note-box admin-caution-first" id="caution-top-content">
            </div>

        <div id="calendar">
            <span class="weekday" style="color: #F44336;">日</span>
            <span class="weekday">月</span>
            <span class="weekday">火</span>
            <span class="weekday">水</span>
            <span class="weekday">木</span>
            <span class="weekday">金</span>
            <span class="weekday" style="color: #2196F3;">土</span>
            </div>

        <div id="submission-area">
            <input type="text" id="staff-name" placeholder="氏名を入力（必須）" required>
            <input type="email" id="staff-email" placeholder="メールアドレス（控え受取用/任意）" style="width: calc(100% - 20px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em;">
            
            <label for="comment" style="font-weight: bold; display: block; margin-bottom: 5px;">備考欄</label>
            <div class="admin-note-box admin-remark-info" id="remark-admin-content">
                </div>
            <textarea id="comment" placeholder="連絡事項など（任意）" rows="3"></textarea>
            
            <div class="admin-note-box admin-caution-second" id="caution-bottom-content">
                </div>

            <button id="submit-button" onclick="submitShifts()">希望シフトを送信</button>
            <div id="loading-message" style="display: none;">送信中...</div>
        </div>

    </div>

    <div id="shift-modal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3><span id="modal-date"></span> のシフト選択</h3>
            
            <div id="shift-option-grid-container" class="shift-option-grid">
                </div>
            
            <button onclick="closeModal()" style="padding: 10px 20px; border-radius: 6px; background-color: #f0f0f0; border: 1px solid #ccc;">閉じる</button>
        </div>
    </div>

    <script>
        // =======================================================
        // === 1. 管理者設定エリア（ここだけ編集してください） ===
        // =======================================================
        
        // 【A】GASのウェブアプリURLを貼り付けてください
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwtkmgZ3EevyFPuxZpBYvvNWaDc_3PJrrm2lKYDf8NgB2wUuGlKUBg5KTqbYUPUzCH_/exec';

        // 【B】シフトの締め切り日を設定してください
        const DEADLINE_DAY = 20; // 例: 20日締め切り

        // 【C】各注意書き欄の内容を編集してください (文頭の「`」と「`」の間だけ編集)
        
        // 1つ目の注意事項 (カレンダーの上部: 黄色)
        // 修正点: シングルクォーテーションをバッククォートに修正しました
        const CAUTION_TEXT_TOP = `締め切りは毎月${DEADLINE_DAY}日です。21日以降は当月のシフトは編集できなくなりますのでご注意ください。`;
        
        // 2つ目の注意事項 (送信ボタンの上: 青色)
        const CAUTION_TEXT_BOTTOM = `特別な希望や、出勤できない曜日、時間帯の変更があればこちらにご記入ください。必ず最新の内容を確認して送信してください。`;

        // 備考欄の説明書き (自由入力欄の上: グレー)
        const REMARK_TEXT_ADMIN = `こちらには、特別な希望（例: 研修のためこの日は早めに上がりたい）や、連絡事項をご記入ください。`;

        // 【D】シフトの項目を編集してください (ラベル、値、クラス名を編集)
        const SHIFT_OPTIONS = [
            { label: '早番', value: '早番', cssClass: 'shift-hayade' },
            { label: '早番6時30分から', value: '早番6時30分から', cssClass: 'shift-hayade-630' },
            { label: '遅番', value: '遅番', cssClass: 'shift-osode' },
            { label: '遅番22時30分まで', value: '遅番22時30分まで', cssClass: 'shift-osode-2230' },
            { label: '休み', value: '休み', cssClass: 'shift-yasumi' }
        ];

        // =======================================================
        // === 2. スクリプト本体（ここから下は編集しないでください） ===
        // =======================================================
        
        let selectedShifts = {};
        let currentDayCell = null;
        let currentDate = new Date();
        let targetMonthDate = new Date(); // 翌月用

        function initCalendar() {
            // 管理者設定テキストをHTMLに挿入
            document.getElementById('caution-top-content').innerHTML = `<strong>【重要】</strong><br>${CAUTION_TEXT_TOP}`;
            document.getElementById('caution-bottom-content').innerHTML = `<strong>【管理者からのお知らせ】</strong><br>${CAUTION_TEXT_BOTTOM}`;
            document.getElementById('remark-admin-content').innerHTML = `<strong>【備考欄記入時の注意】</strong><br>${REMARK_TEXT_ADMIN}`;
            
            // シフト選択ボタンを動的に生成
            createShiftButtons();

            // アクセスした時点で翌月のカレンダーを表示
            targetMonthDate.setMonth(currentDate.getMonth() + 1);
            updateCalendar();
        }

        /**
         * 設定エリアで定義したSHIFT_OPTIONSに基づいてボタンを動的に生成する
         */
        function createShiftButtons() {
            const container = document.getElementById('shift-option-grid-container');
            let buttonsHtml = '';
            
            // 1. 定義されたシフト項目を生成
            SHIFT_OPTIONS.forEach(option => {
                buttonsHtml += `
                    <button class="shift-option ${option.cssClass}" 
                            onclick="selectShift('${option.value}', '${option.cssClass}')">
                        ${option.label}
                    </button>
                `;
            });

            // 2. リセットボタンを生成
            buttonsHtml += `
                <button class="shift-option" style="background-color: #ccc; color: #333;" onclick="selectShift('', '')">
                    リセット (空欄)
                </button>
            `;

            container.innerHTML = buttonsHtml;
        }


        function updateCalendar() {
            const year = targetMonthDate.getFullYear();
            const month = targetMonthDate.getMonth(); // 0-11
            const day = currentDate.getDate(); // 今日の日付
            
            // H2タグの内容を「YYYY年 M月の希望シフト」に変更
            document.getElementById('dynamic-month-title').textContent = `${month + 1}月分の希望シフト入力`;

            const calendarDiv = document.getElementById('calendar');
            // 曜日行より下をクリア
            Array.from(calendarDiv.children).slice(7).forEach(child => child.remove());

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
            const startDay = firstDayOfMonth.getDay();

            // 締め切り判定
            const isDeadlinePassed = currentDate.getMonth() === month && day > DEADLINE_DAY;
            
            // 締め切りが過ぎた場合、送信ボタンを無効化
            const submitButton = document.getElementById('submit-button');
            if (isDeadlinePassed) {
                submitButton.textContent = '締め切り済み（送信不可）';
                submitButton.disabled = true;
                // 注意事項を更新
                document.getElementById('caution-top-content').innerHTML = `
                    <strong>【締め切りのお知らせ】</strong><br>
                    当月${DEADLINE_DAY}日を過ぎたため、${month + 1}月分のシフト希望は締め切りました。
                `;
            } else {
                submitButton.textContent = '希望シフトを送信';
                submitButton.disabled = false;
            }


            // 前月の日付で空白を埋める
            for (let i = 0; i < startDay; i++) {
                calendarDiv.insertAdjacentHTML('beforeend', '<div class="day-cell" style="background-color: #f7f7f7;"></div>');
            }

            // 今月の日付を挿入
            for (let day = 1; day <= lastDateOfMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const shiftValue = selectedShifts[dateString] || '';
                const shiftClass = getShiftClass(shiftValue);
                const dayOfWeek = new Date(year, month, day).getDay(); // 0=日, 6=土

                let dayColor = '#333';
                if (dayOfWeek === 0) dayColor = '#F44336'; // 日曜: 赤
                if (dayOfWeek === 6) dayColor = '#2196F3'; // 土曜: 青

                const isLocked = isDeadlinePassed && month === currentDate.getMonth();

                const dayCellHTML = `
                    <div class="day-cell ${isLocked ? 'locked' : ''}" data-date="${dateString}" onclick="openModal(this, ${day}, ${isLocked})">
                        <span class="date-number" style="color: ${dayColor};">${day}</span>
                        <div class="shift-display ${shiftClass}">${shiftValue}</div>
                    </div>
                `;
                calendarDiv.insertAdjacentHTML('beforeend', dayCellHTML);
            }
        }

        function changeMonth(delta) {
            targetMonthDate.setMonth(targetMonthDate.getMonth() + delta);
            updateCalendar();
        }

        /**
         * GASに送る値に基づいて、対応するCSSクラス名を返す
         */
        function getShiftClass(value) {
            const found = SHIFT_OPTIONS.find(option => option.value === value);
            return found ? found.cssClass : '';
        }

        // === 3. モーダルと選択ロジック ===

        function openModal(cell, day, isLocked) {
            if (isLocked) {
                alert("この月は締め切りを過ぎているため、編集できません。");
                return;
            }

            const dateString = cell.dataset.date;
            const modalDateSpan = document.getElementById('modal-date');
            
            modalDateSpan.textContent = `${dateString.split('-')[1]}月${day}日`;
            
            currentDayCell = cell;
            document.getElementById('shift-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('shift-modal').style.display = 'none';
        }

        function selectShift(value, className) {
            if (!currentDayCell) return;
            
            const dateString = currentDayCell.dataset.date;
            
            // 内部データ更新
            selectedShifts[dateString] = value;
            
            // セル表示の更新
            const shiftDisplay = currentDayCell.querySelector('.shift-display');
            shiftDisplay.textContent = value;
            shiftDisplay.className = `shift-display ${className}`;

            closeModal();
        }

        // === 4. GASへの送信ロジック ===

        async function submitShifts() {
            if (GAS_URL.includes('【ここにGASのウェブアプリURL')) {
                alert("エラー: 管理者設定が必要です。HTML内のURLを設定してください。");
                return;
            }
            
            const name = document.getElementById('staff-name').value.trim();
            const comment = document.getElementById('comment').value;

            if (!name) {
                alert("氏名を入力してください。");
                return;
            }

            const shiftsArray = Object.entries(selectedShifts).map(([date, shift]) => {
                const day = new Date(date).getDate();
                return `${day}日:${shift}`; 
            }).filter(([_, shift]) => shift.trim() !== '日:');

            if (shiftsArray.length === 0) {
                if (!confirm("シフトが一つも選択されていませんが送信しますか？")) return;
            }
            
            const submissionMonth = `${targetMonthDate.getFullYear()}/${targetMonthDate.getMonth() + 1}`;

            const email = document.getElementById('staff-email').value.trim(); // 追加

const payload = {
    name: name,
    email: email, // 追加
    month: submissionMonth, // ※HTML内にこの変数定義がある前提です
    shifts: shiftsArray.join(', '),
    comment: comment
};
            
            document.getElementById('submit-button').disabled = true;
            document.getElementById('loading-message').style.display = 'block';

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'no-cors'
                });

                alert("シフト希望の送信が完了しました！");
                
                // 送信後の状態リセット
                selectedShifts = {};
                document.getElementById('comment').value = '';
                document.getElementById('staff-name').value = '';
                updateCalendar();

            } catch (error) {
                alert("送信中にエラーが発生しました。インターネット接続を確認し、再度お試しください。");
                console.error("Submission error:", error);
            } finally {
                document.getElementById('submit-button').disabled = false;
                document.getElementById('loading-message').style.display = 'none';
            }
        }

        // ページロード時にカレンダーを初期化
        document.addEventListener('DOMContentLoaded', () => {
            initCalendar();
        });
    </script>
</body>
</html>